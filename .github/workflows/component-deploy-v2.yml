name: Deploy V2 (Service Repo)
on:
  workflow_call:
    inputs:
      stage:
        required: true
        type: string
        description: 'stage being released (dev,staging,production)'
      service-name:
        required: true
        type: string
        description: 'Proper name for your service i.e OCPP Service, Vehicle Service'
      service-emoji:
        required: true
        type: string
        description: 'An emoji to identify your service by :)'
      service-identifier:
        required: true
        type: string
        description: 'Identifier of the service being released i.e ocpp, vehicle, server, wallet.'
      image-tag:
        required: true
        type: string
        description: 'Docker image tag to deploy'
      slack-message-id:
        required: false
        type: string
        description: 'Existing Slack message ID to update'
      helm-values-path:
        required: false
        type: string
        description: 'Path to helm values directory (default: helm/{service-identifier}/{stage}/app)'
      repository-name:
        required: false
        type: string
        description: 'Repository name override (default: service-{service-identifier})'
    secrets:
      MANIFEST_REPO_PAT:
        required: true
        description: 'GitHub personal access token'
      SLACK_APP_TOKEN:
        required: true
        description: 'Slack app token'
    outputs:
      slack-message-id:
        description: 'Slack message ID for subsequent updates'
        value: ${{ jobs.deploy.outputs.slack-message-id }}

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Update existing slack message
        uses: monta-app/slack-notifier-cli-action@main
        with:
          job-type: "deploy"
          job-status: "progress"
          service-name: ${{ inputs.service-name }}
          service-emoji: ${{ inputs.service-emoji }}
          slack-app-token: ${{ secrets.SLACK_APP_TOKEN }}
          slack-channel-id: "C01KL9FUPNK"
          slack-message-id: ${{ inputs.slack-message-id }}
      - name: Check out service repository
        uses: actions/checkout@v4
        with:
          repository: monta-app/${{ inputs.repository-name || format('service-{0}', inputs.service-identifier) }}
          path: 'service-repo'
          token: ${{ secrets.MANIFEST_REPO_PAT }}
      - name: Update and push with automatic retry
        uses: Artur-Davtyan/git-rebase-push-action@v1
        with:
          repository_path: service-repo
          commit_message: "Bump docker tag for ${{ inputs.service-identifier }} on ${{ inputs.stage }} to ${{ inputs.image-tag }}"
          user_name: "GitHub Action"
          user_email: "action@github.com"
          yq_command: |
            yq e '.kotlin.image.tag = "${{ inputs.image-tag }}"' -i ${{ inputs.helm-values-path || format('helm/{0}/{1}/app', inputs.service-identifier, inputs.stage) }}/values.yaml
            yq e '.kotlin.revision = "${{ github.sha }}"' -i ${{ inputs.helm-values-path || format('helm/{0}/{1}/app', inputs.service-identifier, inputs.stage) }}/values.yaml
            yq e '.kotlin.build = ${{ github.run_number }}' -i ${{ inputs.helm-values-path || format('helm/{0}/{1}/app', inputs.service-identifier, inputs.stage) }}/values.yaml
          max_retries: 10
          retry_delay: 2
      - name: Publish result message to slack
        if: always()
        uses: monta-app/slack-notifier-cli-action@main
        with:
          job-type: "deploy"
          job-status: ${{ job.status }}
          service-name: ${{ inputs.service-name }}
          service-emoji: ${{ inputs.service-emoji }}
          slack-app-token: ${{ secrets.SLACK_APP_TOKEN }}
          slack-channel-id: "C01KL9FUPNK"
          slack-message-id: ${{ inputs.slack-message-id }}
