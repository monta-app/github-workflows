name: Deploy V2 (Service Repo)
on:
  workflow_call:
    inputs:
      stage:
        required: true
        type: string
        description: 'stage being released (dev,staging,production)'
      service-name:
        required: true
        type: string
        description: 'Proper name for your service i.e OCPP Service, Vehicle Service'
      service-emoji:
        required: true
        type: string
        description: 'An emoji to identify your service by :)'
      service-identifier:
        required: true
        type: string
        description: 'Identifier of the service being released i.e ocpp, vehicle, server, wallet.'
      image-tag:
        required: true
        type: string
        description: 'Docker image tag to deploy'
      slack-message-id:
        required: false
        type: string
        description: 'Existing Slack message ID to update'
      helm-values-path:
        required: false
        type: string
        description: 'Path to helm values directory (default: helm/{service-identifier}/{stage}/app)'
      repository-name:
        required: false
        type: string
        description: 'Repository name override (default: service-{service-identifier})'
    secrets:
      MANIFEST_REPO_PAT:
        required: true
        description: 'GitHub personal access token'
      SLACK_APP_TOKEN:
        required: true
        description: 'Slack app token'
    outputs:
      slack-message-id:
        description: 'Slack message ID for subsequent updates'
        value: ${{ jobs.deploy.outputs.slack-message-id }}

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Update existing slack message
        uses: monta-app/slack-notifier-cli-action@main
        with:
          job-type: "deploy"
          job-status: "progress"
          service-name: ${{ inputs.service-name }}
          service-emoji: ${{ inputs.service-emoji }}
          slack-app-token: ${{ secrets.SLACK_APP_TOKEN }}
          slack-channel-id: "C01KL9FUPNK"
          slack-message-id: ${{ inputs.slack-message-id }}
      - name: Check out service repository
        uses: actions/checkout@v4
        with:
          repository: monta-app/${{ inputs.repository-name || format('service-{0}', inputs.service-identifier) }}
          path: 'service-repo'
          token: ${{ secrets.MANIFEST_REPO_PAT }}
      - name: Update image tag
        shell: bash
        working-directory: ./service-repo/${{ inputs.helm-values-path || format('helm/{0}/{1}/app', inputs.service-identifier, inputs.stage) }}
        run: |
          # Update image tag, revision, and build using yq for proper YAML manipulation
          yq e '.kotlin.image.tag = "${{ inputs.image-tag }}"' -i values.yaml
          yq e '.kotlin.revision = "${{ github.sha }}"' -i values.yaml
          yq e '.kotlin.build = ${{ github.run_number }}' -i values.yaml
      - name: Commit to service repository
        working-directory: './service-repo'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add ${{ inputs.helm-values-path || format('helm/{0}/{1}/app', inputs.service-identifier, inputs.stage) }}/values.yaml
          git commit -m "Bump docker tag for ${{ inputs.service-identifier }} on ${{ inputs.stage }} to ${{ inputs.image-tag }}"
        shell: bash
      - name: Push changes with retry
        working-directory: './service-repo'
        run: |
          MAX_RETRIES=5
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES"

            # Rebase on latest remote
            git fetch origin main
            if ! git rebase origin/main; then
              echo "Rebase conflict - this shouldn't happen with separate service paths"
              git rebase --abort
              RETRY_COUNT=$((RETRY_COUNT + 1))
              sleep $((2 ** RETRY_COUNT))
              continue
            fi

            # Try to push
            if git push origin main; then
              echo "Push successful!"
              exit 0
            fi

            echo "Push failed, retrying..."
            RETRY_COUNT=$((RETRY_COUNT + 1))
            sleep $((2 ** RETRY_COUNT))
          done

          echo "Failed to push after $MAX_RETRIES attempts"
          exit 1
        shell: bash
      - name: Publish result message to slack
        if: always()
        uses: monta-app/slack-notifier-cli-action@main
        with:
          job-type: "deploy"
          job-status: ${{ job.status }}
          service-name: ${{ inputs.service-name }}
          service-emoji: ${{ inputs.service-emoji }}
          slack-app-token: ${{ secrets.SLACK_APP_TOKEN }}
          slack-channel-id: "C01KL9FUPNK"
          slack-message-id: ${{ inputs.slack-message-id }}
