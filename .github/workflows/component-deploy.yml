name: Deploy
on:
  workflow_call:
    inputs:
      stage:
        required: true
        type: string
        description: 'stage being released (dev,staging,production)'
      service-name:
        required: true
        type: string
        description: 'Proper name for your service i.e OCPP Service, Vehicle Service'
      service-emoji:
        required: true
        type: string
        description: 'An emoji to identify your service by :)'
      service-identifier:
        required: true
        type: string
        description: 'Identifier of the service being released i.e ocpp, vehicle, server, wallet.'
      image-tag:
        required: true
        type: string
        description: 'Docker image tag to deploy'
      slack-message-id:
        required: false
        type: string
        description: 'Existing Slack message ID to update'
      argocd-server:
        required: false
        type: string
        description: 'ArgoCD server URL (e.g., argocd.monta.app) for deployment monitoring'
      argocd-sync-wait-seconds:
        required: false
        default: 300
        type: number
        description: 'Timeout duration in seconds to wait for ArgoCD sync to apply'
    secrets:
      MANIFEST_REPO_PAT:
        required: true
        description: 'GitHub personal access token'
      SLACK_APP_TOKEN:
        required: true
        description: 'Slack app token'
      ARGOCD_TOKEN:
        required: false
        description: 'ArgoCD authentication token (required if auto-sync is enabled in config.yaml)'
    outputs:
      slack-message-id:
        description: 'Slack message ID for subsequent updates'
        value: ${{ jobs.deploy.outputs.slack-message-id }}
      stage:
        description: 'Stage this was deployed to (dev,staging,production)'
        value: ${{ jobs.deploy.outputs.stage }}
      docker-image:
        description: 'Docker image with repository'
        value: ${{ jobs.deploy.outputs.docker-image }}
      previous-image-tag:
        description: 'Docker image tag before the release'
        value: ${{ jobs.deploy.outputs.previous-image-tag }}
      image-tag:
        description: 'Docker image tag that was deployed'
        value: ${{ jobs.deploy.outputs.image-tag }}
      deployment-start-time:
        description: 'ISO 8601 timestamp when ArgoCD started the sync (only if auto-sync enabled)'
        value: ${{ jobs.deploy.outputs.deployment-start-time }}
      deployment-end-time:
        description: 'ISO 8601 timestamp when deployment became healthy (only if auto-sync enabled)'
        value: ${{ jobs.deploy.outputs.deployment-end-time }}
      deployment-url:
        description: 'Direct URL to the application in ArgoCD UI (only if auto-sync enabled)'
        value: ${{ jobs.deploy.outputs.deployment-url }}

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      slack-message-id: ${{ steps.slack-update.outputs.message-id }}
      stage: ${{ inputs.stage }}
      docker-image: ${{ steps.update-image-tag.outputs.docker-image }}
      previous-image-tag: ${{ steps.update-image-tag.outputs.previous-image-tag }}
      image-tag: ${{ inputs.image-tag }}
      deployment-start-time: ${{ steps.argocd-sync.outputs.deployment-start-time }}
      deployment-end-time: ${{ steps.argocd-sync.outputs.deployment-end-time }}
      deployment-url: ${{ steps.argocd-sync.outputs.deployment-url }}
    steps:
      - name: Update existing slack message
        id: slack-update
        uses: monta-app/slack-notifier-cli-action@main
        with:
          job-type: "deploy"
          job-status: "progress"
          service-name: ${{ inputs.service-name }}
          service-emoji: ${{ inputs.service-emoji }}
          slack-app-token: ${{ secrets.SLACK_APP_TOKEN }}
          slack-channel-id: "C01KL9FUPNK"
          slack-message-id: ${{ inputs.slack-message-id }}
      - name: Check out manifest repository
        uses: actions/checkout@v4
        with:
          repository: monta-app/kube-manifests
          path: 'manifests'
          token: ${{ secrets.MANIFEST_REPO_PAT }}
      - name: Update image tag
        id: update-image-tag
        shell: bash
        working-directory: ./manifests/apps/${{ inputs.service-identifier }}/${{ inputs.stage }}/app
        run: |
          echo "docker-image=$(yq .kotlin.image.repository values.yaml)" >> "$GITHUB_OUTPUT"
          echo "previous-image-tag=$(yq .kotlin.image.tag values.yaml)" >> "$GITHUB_OUTPUT"

          sed -i "s/tag: .*/tag: ${{ inputs.image-tag }}/" values.yaml
          sed -i "s/revision: .*/revision: \"${GITHUB_SHA::8}\"/" values.yaml
          sed -i "s/build: .*/build: ${{ github.run_number }}/" values.yaml
      - name: Update config
        shell: bash
        working-directory: ./manifests/apps/${{ inputs.service-identifier }}/${{ inputs.stage }}/cluster
        run: |
          # Update previousHash
          previousHash=$(yq e .currentHash config.yaml) yq e '.previousHash = strenv(previousHash)' -i config.yaml
          # Update currentHash
          currentHash=${GITHUB_SHA::8} yq e '.currentHash = strenv(currentHash)' -i config.yaml
      - name: Detect ArgoCD auto-sync configuration
        id: detect-autosync
        shell: bash
        working-directory: ./manifests/apps/${{ inputs.service-identifier }}/${{ inputs.stage }}/cluster
        run: |
          # Check if autoSync is configured in config.yaml
          if yq e '.autoSync' config.yaml | grep -q -v "null"; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
            echo "✓ ArgoCD auto-sync is enabled for this application"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "⏭️ ArgoCD auto-sync is not configured for this application"
          fi
      - name: Commit and push with automatic retry
        shell: bash
        working-directory: ./manifests
        env:
          APP_PATH: apps/${{ inputs.service-identifier }}/${{ inputs.stage }}/app
          CLUSTER_PATH: apps/${{ inputs.service-identifier }}/${{ inputs.stage }}/cluster
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

          git add .
          git commit -m "Bump docker tag for ${{ inputs.service-identifier }} on ${{ inputs.stage }} to ${{ inputs.image-tag }}"

          for attempt in $(seq 1 10); do
            echo "Push attempt $attempt..."
            if git push origin main; then
              echo "Push successful after $attempt attempt(s)"
              exit 0
            fi
            echo "Push failed, rebasing and retrying..."
            git fetch origin main
            if git rebase origin/main; then
              echo "Rebase clean, retrying push..."
            else
              echo "Rebase conflict, re-applying changes on top of latest main..."
              git rebase --abort
              git reset --soft origin/main
              sed -i "s/tag: .*/tag: ${{ inputs.image-tag }}/" "$APP_PATH/values.yaml"
              sed -i "s/revision: .*/revision: \"${GITHUB_SHA::8}\"/" "$APP_PATH/values.yaml"
              sed -i "s/build: .*/build: ${{ github.run_number }}/" "$APP_PATH/values.yaml"
              previousHash=$(yq e .currentHash "$CLUSTER_PATH/config.yaml") yq e '.previousHash = strenv(previousHash)' -i "$CLUSTER_PATH/config.yaml"
              currentHash=${GITHUB_SHA::8} yq e '.currentHash = strenv(currentHash)' -i "$CLUSTER_PATH/config.yaml"
              git add .
              git commit -m "Bump docker tag for ${{ inputs.service-identifier }} on ${{ inputs.stage }} to ${{ inputs.image-tag }}"
            fi
            sleep 2
          done
          echo "Failed after 10 attempts"
          exit 1
      - name: Get manifest commit SHA
        id: manifest-sha
        shell: bash
        working-directory: './manifests'
        run: |
          MANIFEST_SHA=$(git rev-parse HEAD)
          echo "sha=$MANIFEST_SHA" >> "$GITHUB_OUTPUT"
          echo "Manifest commit SHA: $MANIFEST_SHA"
      - name: Check ArgoCD credentials
        id: check-argocd-creds
        shell: bash
        env:
          ARGOCD_SERVER: ${{ inputs.argocd-server }}
          ARGOCD_TOKEN: ${{ secrets.ARGOCD_TOKEN }}
        run: |
          if [ -n "$ARGOCD_SERVER" ] && [ -n "$ARGOCD_TOKEN" ]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Log ArgoCD sync skip
        if: ${{ steps.detect-autosync.outputs.enabled == 'false' || steps.check-argocd-creds.outputs.available == 'false' }}
        shell: bash
        run: |
          if [ "${{ steps.detect-autosync.outputs.enabled }}" = "false" ]; then
            echo "⏭️ Skipping ArgoCD sync monitoring - auto-sync is not configured for this application"
          else
            echo "⏭️ Skipping ArgoCD sync monitoring - argocd-server input or ARGOCD_TOKEN secret not provided"
          fi
      - name: Wait for ArgoCD sync
        if: ${{ steps.detect-autosync.outputs.enabled == 'true' && steps.check-argocd-creds.outputs.available == 'true' }}
        id: argocd-sync
        uses: monta-app/github-workflows/.github/actions/argocd-wait-sync@main
        with:
          server: ${{ inputs.argocd-server }}
          app-name: ${{ inputs.service-identifier }}-${{ inputs.stage }}
          auth-token: ${{ secrets.ARGOCD_TOKEN }}
          revision: ${{ steps.manifest-sha.outputs.sha }}
          timeout: ${{ inputs.argocd-sync-wait-seconds }}
          github-token: ${{ secrets.MANIFEST_REPO_PAT }}
      - name: Publish result message to slack
        if: always()
        uses: monta-app/slack-notifier-cli-action@main
        with:
          job-type: "deploy"
          job-status: ${{ job.status }}
          service-name: ${{ inputs.service-name }}
          service-emoji: ${{ inputs.service-emoji }}
          slack-app-token: ${{ secrets.SLACK_APP_TOKEN }}
          slack-channel-id: "C01KL9FUPNK"
          slack-message-id: ${{ inputs.slack-message-id }}
