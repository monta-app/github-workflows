name: Build and test
on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
        description: 'Name of the service being tested'
      gradle-module:
        required: false
        type: string
        description: 'Name of the gradle module being tested'
    secrets:
      GHL_USERNAME:
        required: true
        description: 'Github Username (Gradle plugin)'
      GHL_PASSWORD:
        required: true
        description: 'Github Password (Gradle plugin)'
      SLACK_BOT_TOKEN:
        required: true
        description: 'Deployment alert slack webhook url'
jobs:
  build:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - id: slack
        uses: slackapi/slack-github-action@v1.23.0
        with:
          channel-id: "C01KL9FUPNK"
          payload: |
            {
              "text": "$SERVICE_NAME - Test workflow üß™",
              "attachments": [
                {
                  "color": "dbab09",
                  "fields": [
                    {
                      "title": "Status",
                      "short": true,
                      "value": "In Progress üöß"
                    }
                  ]
                }
              ]
            }
        env:
          SERVICE_NAME: ${{ inputs.service-name }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN}}
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      - name: Test project
        env:
          GHL_USERNAME: ${{ secrets.GHL_USERNAME }}
          GHL_PASSWORD: ${{ secrets.GHL_PASSWORD }}
          GRADLE_MODULE: ${{ inputs.gradle-module }}
        run: ./gradlew --no-daemon $GRADLE_MODULE:test
        shell: bash
      - name: Upload test results
        if: ${{ always() }}
        uses: actions/upload-artifact@v3
        with:
          name: test-result
          path: |
            build/reports/tests/test
            /home/runner/.gradle/daemon/**/daemon-*.out.log
          retention-days: 2
      - name: Generate Status String
        if: ${{ always() }}
        id: status
        env:
          GITHUB_JOB_STATUS: ${{ job.status }}
        run: |
          case $GITHUB_JOB_STATUS in
            success)
              echo "STATUS_STRING='Success ‚úÖ'" >> $GITHUB_OUTPUT
              ;;
            failure)
              echo "STATUS_STRING='Failure ‚ùå'" >> $GITHUB_OUTPUT
              ;;
            cancelled)
              echo "STATUS_STRING='Cancelled üö∏'" >> $GITHUB_OUTPUT
              ;;
            *)
              echo -n "Something went wrong ‚ÅâÔ∏è"
              ;;
          esac
      - uses: slackapi/slack-github-action@v1.23.0
        if: ${{ always() }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN}}
        with:
          channel-id: "C01KL9FUPNK"
          update-ts: ${{ steps.slack.outputs.ts }}
          payload: |
            {
              "text": "${{ inputs.service-name }} - Test workflow üß™",
              "attachments": [
                {
                  "color": "28a745",
                  "fields": [
                    {
                      "title": "Status",
                      "short": true,
                      "value": ${{ steps.status.outputs.STATUS_STRING }}
                    }
                  ]
                }
              ]
            }
