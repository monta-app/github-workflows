name: Semgrep Security Scan
on:
  workflow_call:
    inputs:
      language:
        required: true
        type: string
        description: "Primary language to scan: 'kotlin', 'php', or 'generic'"
      extra-configs:
        required: false
        type: string
        description: "Additional Semgrep config flags (e.g., '--config p/react')"
        default: ""
      timeout-minutes:
        required: false
        type: number
        description: "Timeout for the scan job in minutes"
        default: 15

jobs:
  semgrep:
    name: Security Scan
    runs-on: linux-arm64
    timeout-minutes: ${{ inputs.timeout-minutes }}
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install Semgrep
        run: pip install semgrep==1.86.0

      - name: Get changed files
        id: changed-files
        run: |
          # Get list of changed files in this PR (null-delimited for safety)
          git diff --name-only -z origin/${{ github.base_ref }}...HEAD > changed_files.txt
          echo "Changed files:"
          tr '\0' '\n' < changed_files.txt
          echo "count=$(tr '\0' '\n' < changed_files.txt | wc -l)" >> "$GITHUB_OUTPUT"

      - name: Determine Semgrep configs
        id: configs
        run: |
          LANGUAGE="${{ inputs.language }}"
          EXTRA="${{ inputs.extra-configs }}"

          # Base configs for all languages
          CONFIGS="--config p/security-audit --config p/secrets --config p/github-actions --config p/docker"

          # Language-specific configs
          case "$LANGUAGE" in
            kotlin)
              CONFIGS="$CONFIGS --config p/kotlin --config p/java --config r/kotlin.lang.security --config r/java.lang.security"
              ;;
            php)
              CONFIGS="$CONFIGS --config p/php --config r/php.lang.security"
              ;;
            generic)
              # Just base configs
              ;;
            *)
              echo "Unknown language: $LANGUAGE"
              exit 1
              ;;
          esac

          # Add extra configs if provided
          if [ -n "$EXTRA" ]; then
            CONFIGS="$CONFIGS $EXTRA"
          fi

          echo "configs=$CONFIGS" >> "$GITHUB_OUTPUT"
          echo "Using configs: $CONFIGS"

      - name: Run Semgrep (diff only)
        run: |
          if [ -s changed_files.txt ]; then
            # Filter to only existing files (exclude deleted files), handle special chars safely
            xargs -0 -I {} sh -c "test -f \"\$1\" && printf \"%s\\0\" \"\$1\"" _ {} < changed_files.txt > files_to_scan.txt || true

            if [ -s files_to_scan.txt ]; then
              echo "Scanning changed files..."
              # Use xargs with null delimiter for safe filename handling
              set +e
              xargs -0 semgrep scan \
                ${{ steps.configs.outputs.configs }} \
                --json \
                --output=semgrep.json \
                < files_to_scan.txt \
                2>&1
              SEMGREP_EXIT_CODE=$?
              set -e
              if [ "$SEMGREP_EXIT_CODE" -ne 0 ]; then
                echo "::warning::Semgrep scan exited with non-zero status: $SEMGREP_EXIT_CODE"
                if [ ! -f semgrep.json ]; then
                  echo '{"results":[],"errors":[{"message":"Semgrep scan failed","exit_code":'"$SEMGREP_EXIT_CODE"'}]}' > semgrep.json
                fi
              fi
            else
              echo '{"results":[],"errors":[]}' > semgrep.json
              echo "No files to scan after filtering"
            fi
          else
            echo '{"results":[],"errors":[]}' > semgrep.json
            echo "No changed files"
          fi

      - name: Evaluate findings
        id: evaluate
        if: always()
        run: |
          if [ -f semgrep.json ]; then
            TOTAL=$(jq '.results | length' semgrep.json)
            HIGH=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' semgrep.json)
            MEDIUM=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' semgrep.json)
            LOW=$(jq '[.results[] | select(.extra.severity == "INFO")] | length' semgrep.json)

            {
              echo "high=$HIGH"
              echo "medium=$MEDIUM"
              echo "low=$LOW"
              echo "total=$TOTAL"
            } >> "$GITHUB_OUTPUT"

            {
              echo "### Semgrep Results"
              echo "| Severity | Count |"
              echo "|----------|-------|"
              echo "| High | $HIGH |"
              echo "| Medium | $MEDIUM |"
              echo "| Low | $LOW |"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            {
              echo "high=0"
              echo "medium=0"
              echo "low=0"
              echo "total=0"
            } >> "$GITHUB_OUTPUT"

            {
              echo "### Semgrep Results"
              echo "No findings or scan failed to produce output."
            } >> "$GITHUB_STEP_SUMMARY"
          fi

      # This step is intended for workflows triggered by pull_request events.
      # When invoked from other events (e.g., via workflow_call on push),
      # github.event_name will not be 'pull_request' and this step will be skipped.
      - name: Post PR Comment
        if: steps.evaluate.outputs.total > 0 && github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let findings = [];
            let parseError = false;

            if (fs.existsSync('semgrep.json')) {
              try {
                const data = JSON.parse(fs.readFileSync('semgrep.json', 'utf8'));
                findings = data.results || [];
              } catch (e) {
                parseError = true;
                console.error('Failed to parse JSON:', e);
              }
            }

            const high = findings.filter(f => f.extra?.severity === 'ERROR');
            const medium = findings.filter(f => f.extra?.severity === 'WARNING');
            const low = findings.filter(f => f.extra?.severity === 'INFO');

            let body = `## Semgrep Security Scan\n\n`;

            if (parseError) {
              body += `Failed to parse scan results. Check workflow logs.\n`;
            } else if (findings.length === 0) {
              body += `No security findings detected.\n`;
            } else {
              body += `| Severity | Count |\n|----------|-------|\n`;
              body += `| High | ${high.length} |\n`;
              body += `| Medium | ${medium.length} |\n`;
              body += `| Low | ${low.length} |\n\n`;

              if (high.length > 0) {
                body += `### High Severity (Blocking)\n\n`;
                high.slice(0, 15).forEach(f => {
                  const path = f.path || 'unknown';
                  const line = f.start?.line || '?';
                  const ruleId = f.check_id || 'unknown-rule';
                  const message = f.extra?.message || 'No description';
                  body += `- **${ruleId}** in \`${path}:${line}\`\n`;
                  body += `  > ${message.substring(0, 200)}${message.length > 200 ? '...' : ''}\n\n`;
                });
                if (high.length > 15) {
                  body += `... and ${high.length - 15} more high severity findings\n\n`;
                }
              }

              if (medium.length > 0) {
                body += `<details>\n<summary>Medium Severity (${medium.length})</summary>\n\n`;
                medium.slice(0, 10).forEach(f => {
                  const path = f.path || 'unknown';
                  const line = f.start?.line || '?';
                  const ruleId = f.check_id || 'unknown-rule';
                  body += `- **${ruleId}** in \`${path}:${line}\`\n`;
                });
                if (medium.length > 10) {
                  body += `\n... and ${medium.length - 10} more\n`;
                }
                body += `\n</details>\n\n`;
              }

              if (low.length > 0) {
                body += `<details>\n<summary>Low Severity (${low.length})</summary>\n\n`;
                low.slice(0, 10).forEach(f => {
                  const path = f.path || 'unknown';
                  const line = f.start?.line || '?';
                  const ruleId = f.check_id || 'unknown-rule';
                  body += `- **${ruleId}** in \`${path}:${line}\`\n`;
                });
                if (low.length > 10) {
                  body += `\n... and ${low.length - 10} more\n`;
                }
                body += `\n</details>\n\n`;
              }
            }

            body += `\n[View workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;
            body += `\n<!-- semgrep-report -->`;

            // Find and update existing comment, or create new
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const existing = comments.find(c => c.body?.includes('<!-- semgrep-report -->'));

            if (existing) {
              await github.rest.issues.updateComment({
                comment_id: existing.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              });
            }

      - name: Fail on High Severity
        if: always()
        run: |
          HIGH="${{ steps.evaluate.outputs.high }}"
          echo "High severity count: $HIGH"
          if [ -n "$HIGH" ] && [ "$HIGH" -gt 0 ]; then
            echo "::error::Found $HIGH high-severity security findings"
            exit 1
          fi
          echo "No high-severity findings detected"
